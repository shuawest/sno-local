---

# UTM allows for VM control through Apple Script, but not all VM
# settings can be controlled through the script and vice versa.
# So a template VM is generated from as a source to be cloned then
# the template VM is removed.

###
# clean prior VMs

- name: Clean the VM if it exists
  ansible.builtin.include_role:
    name: utm
    tasks_from: clean_vm.yml
  vars:
    clean_utm_vm_name: "{{ utm_vm_name }}"
    clean_utm_vm_dir: "{{ utm_vm_dir }}"

- name: Clean the template VM if it exists
  ansible.builtin.include_role:
    name: utm
    tasks_from: clean_vm.yml
  vars:
    utm_clean_vm: true
    clean_utm_vm_name: "{{ utm_vm_tmpl_name }}"
    clean_utm_vm_dir: "{{ utm_vm_tmpl_dir }}"

###
# create the template 

- name: Prep the template VM
  ansible.builtin.include_role:
    name: utm
    tasks_from: prep_vm.yml
  vars:
    prep_utm_vm_name: "{{ utm_vm_tmpl_name }}"
    prep_utm_vm_dir: "{{ utm_vm_tmpl_dir }}"

- name: Generate template config.plist
  ansible.builtin.template:
    src: templates/config.plist.j2
    dest: "{{ utm_vm_tmpl_dir }}/config.plist"
    mode: '0644'
  vars:
    j2_utm_vm_name: "{{ utm_vm_tmpl_name }}"
    j2_utm_vm_dir: "{{ utm_vm_tmpl_dir }}"

- name: Load VM template into UTM
  ansible.builtin.shell: |
    open '{{ utm_vm_tmpl_dir }}'

###
# clone the template, and set drives

- name: Create the VM from the template
  ansible.builtin.shell: |
    osascript -e 'tell application "UTM"
      set iso to POSIX file "{{ utm_boot_iso }}"
      set tmpl to virtual machine named "{{ utm_vm_tmpl_name }}"
      duplicate tmpl with properties { ¬
        configuration: { ¬
          name:"{{ utm_vm_name }}", ¬ 
          drives: { ¬ 
            { guest size: {{ utm_disk_primary_size }} }, ¬ 
            { guest size: {{ utm_disk_secondary_size }} }, ¬ 
            { removable: true, source:iso, guest size:65536 } ¬ 
          } ¬
        } ¬ 
      }
    end tell'

- name: Set MAC Address of the VM
  ansible.builtin.shell: |
    osascript -e 'tell application "UTM"
      set vm to virtual machine named "{{ utm_vm_name }}"
      set config to configuration of vm
      set net to item 1 of network interfaces of config
      set address of net to "{{ utm_vm_mac_addr }}"
      update configuration of vm with config
    end tell'

###
# clean up the template

- name: Clean the template VM 
  ansible.builtin.include_role:
    name: utm
    tasks_from: clean_vm.yml
  vars:
    utm_clean_vm: true
    clean_utm_vm_name: "{{ utm_vm_tmpl_name }}"
    clean_utm_vm_dir: "{{ utm_vm_tmpl_dir }}"









